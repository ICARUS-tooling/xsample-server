<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui" xmlns:jsf="http://xmlns.jcp.org/jsf">
	
	<h:form id="query">
		<p:remoteCommand name="initQuery" action="#{queryPage.init}"
			process="@this" update="@form" oncomplete="initOutline();" />
			
		<h:inputHidden id="excerptThreshold" value="#{xsampleQueryData.limit}" readonly="#{true}" />
		<h:inputHidden id="excerptRange" value="#{xsampleQueryData.range}" readonly="#{true}" />
		<h:inputHidden id="excerptQuota" value="#{xsampleQueryData.quota}" readonly="#{true}" />
		
		<div>
			<p:textEditor widgetVar="editor" height="300" placeholder="#{bundle['query.editor.placeholder']}"
					value="#{queryView.query}" secure="false" required="true">
				<f:facet name="toolbar">
					<span class="ql-formats">
						There be cool stuff for customizing queries...
						<!-- leave toolbar empty for now -->
					</span>
				</f:facet>
			</p:textEditor>
		</div>
		<div>
			<p:messages for="queryMsgs" for="navMsgs" id="queryMsg" closable="true" redisplay="false" skipDetailIfEqualsSummary="true" />
			<p:commandButton value="#{bundle['query.runQuery']}" action="#{queryPage.runQuery}"
					update="queryMsg" />
		</div>
		<div>
			<ui:include src="/outline.xhtml">
				<ui:param name="canvasId" value="result" />
				<ui:param name="canvasWidth" value="700" />
				<ui:param name="showLegend" value="false" />
			</ui:include>
		</div>
		<div>
			<ui:include src="/outline.xhtml">
				<ui:param name="canvasId" value="outline" />
				<ui:param name="canvasWidth" value="700" />
				<ui:param name="showLegend" value="true" />
			</ui:include>
		</div>
		<div>
        	<p:messages id="navMsg" showSummary="true" showDetail="false" redisplay="false" />
			<p:commandButton value="#{bundle['back']}" action="#{queryPage.back}" process="@this" />
			<p:commandButton widgetVar="wv_continue" value="#{bundle['continue']}" 
				action="#{queryPage.next}" disabled="#{queryPage.hasResult}"/>
		</div>
	</h:form>

				
	<h:outputScript library="js" name="xsample-common.js" target="body" />
	<h:outputScript library="js" name="xsample-slice.js" target="body" />
	<h:outputScript>	
		var excerpt = [];
		var quota = [];
		
		function updateOutline() {	
			var range = Number(document.getElementById('query:excerptRange').value);
			var limit = Number(document.getElementById('query:excerptThreshold').value);
			var canvas = document.getElementById('outline');
			var used = combinedSize(quota, excerpt, limit);
			var exceeded = used>limit;
			var style = exceeded ? OUTLINE_EXCEEDED : OUTLINE_EXCERPT;
		
			paintExcerpt(canvas, quota, excerpt, range, style);	
		}
		
		function initOutline() {		
			var encodedQuota = document.getElementById('query:excerptQuota').value;			
			quota = parseFragments(encodedQuota);
			//console.log(quota);
			updateOutline();
		}
		
		$('document').ready(function(){
			initQuery();
		});
	</h:outputScript>
</ui:composition>